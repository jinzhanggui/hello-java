#### mysql的基础架构/MySql的执行流程？
![](../img/MySql基础架构.jpg)

连接器负责跟客户端建立链接、获取权限、维持和管理连接

缓存是以K-V的形式存储的，K是sql，V是结果集，命中就返回缓存的value，如果不命中就执行后面的阶段

可以通过如下命令查询缓存的类型

![](../img/mysql查询缓存类型.png)

mysql 8 以上默认关闭，因为缓存命中率太低，因为该table的任意修改都会导致该table所有的缓存失效

而且select * from user和select a.* from user a会被认为是不同的语句

分析器会先做词法分析，你的语句有这么多单词、空格，MySQL就需要识别每个字符串所代表的是什么，是关键字，还是表名，还是列名等等。
   
然后就开始语法分析，根据词法分析的结果，语法分析会判断你sql的对错，错了会提醒你的，并且会提示你哪里错了

优化器有一步就是要确认使用哪个索引，比如使用你的主键索引，联合索引还是什么索引更好

还有就是对执行顺序进行优化，条件那么多，先查哪个表，还是先关联，会出现很多方案，最后由优化器决定选用哪种方案，也即生成执行计划

执行器按照执行计划一条条的调用底层引擎接口查数据

#### 索引可以有哪些数据结构？
哈希表、数组、完全平衡二叉树、B树、B+树都可以

哈希表的特点就是可以快速的精确查询，但是不支持范围查询

有序数组，在等值查询的和范围查询的时候都很Nice，通过二位数组记录按年划分的历史数据，缺点是新增/删除时需要移动数组

完全平衡二叉树是有序的，支持范围查询，时间复杂度是O(log(N))，但索引也不只是在内存里面存储的，还是要落盘持久化的,如果数据多了，树高会很高，查询的成本就会随着树高的增加而增加

B树的表示要比完全平衡二叉树要“矮”，原因在于B树中的一个节点可以存储多个元素。

B+树的表示要比B树要“胖”，原因在于B+树中的非叶子节点会冗余一份在叶子节点中，并且叶子节点之间用指针相连.

最开始的Hash不支持范围查询，二叉树树高很高，只有B树跟B+有的一比。

B树一个节点可以存储多个元素，相对于完全平衡二叉树整体的树高降低了，磁盘IO效率提高了。

而B+树是B树的升级版，只是把非叶子节点冗余一下，这么做的好处是为了提高范围查找的效率。

#### 一个B+树的节点中到底存多少个元素最合适你有了解过么？
因为是按页加载的，所以把一个节点的大小控制在1页、2页、3页、4页等倍数页大小最为合适。

#### 数据库的页结构是怎样的？

![](../img/页结构.jpg)

各个数据页可以组成一个双向链表

而每个数据页中的记录又可以组成一个单向链表

每个数据页都会为存储在它里边儿的记录生成一个页目录，在通过主键查找某条记录的时候可以在页目录中使用二分法快速定位到对应的槽，然后再遍历该槽对应分组中的记录即可快速找到指定的记录

以其他列(非主键)作为搜索条件：只能从最小记录开始依次遍历单链表中的每条记录。

#### 回表
回表大概就是我们有个主键为ID的索引，和一个普通name字段的索引，我们在普通字段上搜索：
select * from t where name='a';
执行的流程是先查询到name索引上的“a”，然后找到他的id是1，最后去主键索引，找到id为1对应的值。

#### 覆盖索引
接回表的知识点，如果你仅需要查找对应的id,则不需要回表，因为该索引已经可以直接返回了，这种现象叫索引覆盖，本质上是所要查找的东西能不能一次性返回

很多联合索引的建立，就是为了支持覆盖索引，特定的业务能极大的提升效率。

#### 最左匹配原则

* 索引可以简单如一个列 (a)，也可以复杂如多个列 (a,b,c,d)，即联合索引。

* 如果是联合索引，那么key也由多个列组成，同时，索引只能用于查找key是否存在（相等），遇到范围查询 (>、<、between、like左匹配)等就不能进一步匹配了，后续退化为线性查找。

* 因此，列的排列顺序决定了可命中索引的列数。

#### 其他散列知识点

##### 查看数据库连接状态
```mysql
show processlist ;
```
![](../img/查看MySql连接状态.jpg)

这里需要注意的是，我们数据库的客户端太久没响应，连接器就会自动断开了，这个时间参数是wait_timeout控制住的，默认时长为8小时。

断开后重连的时候会报错，如果你想再继续操作，你就需要重连了。

可以通过长连接去解决，其实长连接是相对于通常的短连接而说的，也就是长时间保持客户端与服务端的连接状态。

通常的短连接操作步骤是：

连接-》数据传输-》关闭连接；

而长连接通常就是：

连接-》数据传输-》保持连接-》数据传输-》保持连接-》…………-》关闭连接；

这就要求长连接在没有数据通信时，定时发送数据包，以维持连接状态，短连接在没有数据传输时直接关闭就行了。

因为链接只有在断开的时候才能可以释放内存资源，如果一直使用长连接，服务端可能会OOM，会导致MySQL重启，客户端可能会频繁的Full GC。
因为每次查询用到的临时内存没有得到释放。可以通过定期断开长连接，或者程序里面判断执行过一个占用内存比较大的查询后就断开连接，需要的时候重连。
其实更推荐在执行一个比较大的查询后，执行mysql_reset_connection可以重新初始化连接资源。这个过程相比上面一种会好点，不需要重连，但是会初始化连接的状态。
